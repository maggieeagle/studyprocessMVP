<UserControl x:Class="UI.Views.CoursePage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:helpers="clr-namespace:UI.Helpers"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800"
             Background="Transparent">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <helpers:BindingProxy x:Key="VmProxy" Data="{Binding}" />
    </UserControl.Resources>

    <Grid Margin="32,24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Button Grid.Row="0" 
                Content="← Back to Courses" 
                Command="{Binding GoBackCommand}"
                Style="{StaticResource LinkButtonStyle}"
                HorizontalAlignment="Left"
                Margin="0,0,0,20"
                FontSize="14"/>

        <Border Grid.Row="1"
                Style="{StaticResource CardStyle}"
                Padding="24"
                Margin="0,0,0,24">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="{Binding CourseName}" 
                               Style="{StaticResource HeadingStyle}"
                               FontSize="24"
                               Margin="0,0,0,8"/>
                    <StackPanel Orientation="Horizontal">
                        <Border Background="{StaticResource SurfaceLightBrush}"
                                CornerRadius="4"
                                Padding="8,4"
                                Margin="0,0,12,0">
                            <TextBlock Text="{Binding Code}" 
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       FontSize="12"
                                       FontWeight="Medium"/>
                        </Border>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="👨‍🏫" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Teacher:" 
                                       Foreground="{StaticResource TextMutedBrush}"
                                       FontSize="13"
                                       Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding TeacherName}" 
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       FontSize="13"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            VerticalAlignment="Center"
                            Visibility="{Binding Data.IsTeacher, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVis}}">
                    <Button Content="+ Add Assignment" 
                            Command="{Binding OpenAddAssignmentWindowCommand}"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Padding="16,10"
                            Margin="0,0,12,0"/>
                    <Button Content="📥 Export CSV"
                            Command="{Binding ExportAssignmentsCsvCommand}"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Padding="16,10"/>
                </StackPanel>
            </Grid>
        </Border>

        <TextBlock Grid.Row="2"
                   Text="Assignments"
                   Style="{StaticResource HeadingStyle}"
                   FontSize="18"
                   Margin="0,0,0,16"/>

        <Border Grid.Row="3"
                Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="12">
            <DataGrid ItemsSource="{Binding Assignments}"
                      Style="{StaticResource DataGridStyle}"
                      ColumnHeaderStyle="{StaticResource DataGridColumnHeaderStyle}"
                      CellStyle="{StaticResource DataGridCellStyle}"
                      RowStyle="{StaticResource DataGridRowStyle}"
                      BorderThickness="0"
                      AlternationCount="2"
                      IsReadOnly="{Binding IsStudent}">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="Assignment" 
                                        Binding="{Binding Name, UpdateSourceTrigger=LostFocus}" 
                                        Width="150">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                <Setter Property="FontWeight" Value="Medium"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                <Setter Property="Padding" Value="8,6"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="Description" 
                                        Binding="{Binding Description, UpdateSourceTrigger=LostFocus}" 
                                        Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                <Setter Property="Padding" Value="8,6"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                    </DataGridTextColumn>

                    <DataGridTemplateColumn Header="Type" Width="100">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="4"
                                        Padding="8,4"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#1A6366F1"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Type}" Value="Exam">
                                                    <Setter Property="Background" Value="#1AEF4444"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding Type}" FontSize="11" FontWeight="Medium">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource PrimaryLightBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Type}" Value="Exam">
                                                        <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Due Date" 
                                        Binding="{Binding DueDate, StringFormat='MMM dd, yyyy', UpdateSourceTrigger=LostFocus}" 
                                        Width="120">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTemplateColumn Header="Status" Width="110">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="12"
                                        Padding="10,4"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#1A64748B"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Submitted">
                                                    <Setter Property="Background" Value="#1A22C55E"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Overdue">
                                                    <Setter Property="Background" Value="#1AEF4444"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding Status}" FontSize="11" FontWeight="Medium">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Status}" Value="Submitted">
                                                        <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Overdue">
                                                        <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn x:Name="GradeColumn" Header="Grade" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Grade}"
                                           Foreground="{StaticResource SecondaryBrush}"
                                           FontWeight="SemiBold"
                                           FontSize="14"
                                           VerticalAlignment="Center"
                                           Visibility="{Binding Data.IsStudent, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVis}}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="Action" Width="240" MinWidth="240">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                    <Button CommandParameter="{Binding}"
                                            Margin="4,0">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
                                                <Setter Property="Content" Value="Submit"/>
                                                <Setter Property="Padding" Value="14,8"/>
                                                <Setter Property="Command" Value="{Binding DataContext.OpenSubmitWindowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding Status}" Value="Submitted"/>
                                                            <Condition Binding="{Binding Data.IsStudent, Source={StaticResource VmProxy}}" Value="True"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </MultiDataTrigger>
                                                    <DataTrigger Binding="{Binding Data.IsTeacher, Source={StaticResource VmProxy}}" Value="True">
                                                        <Setter Property="Content" Value="Submissions"/>
                                                        <Setter Property="Command" Value="{Binding DataContext.OpenViewSubmissionsWindowCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <Button ToolTip="Save Changes"
                                            Command="{Binding Data.UpdateAssignmentCommand, Source={StaticResource VmProxy}}"
                                            CommandParameter="{Binding}"
                                            Background="#3B82F6"
                                            Foreground="White"
                                            BorderThickness="0"
                                            IsEnabled="{Binding IsDirty}"
                                            Width="32" Height="32"
                                            Margin="4,0"
                                            Cursor="Hand"
                                            Visibility="{Binding Data.IsTeacher, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVis}}">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <TextBlock Text="✓" FontSize="16" FontWeight="Bold"
                                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                                               Foreground="White"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                    <Button ToolTip="Delete Assignment"
                                            Command="{Binding Data.DeleteAssignmentCommand, Source={StaticResource VmProxy}}"
                                            CommandParameter="{Binding}"
                                            Background="#DC2626"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Width="32" Height="32"
                                            Margin="4,0"
                                            Cursor="Hand"
                                            Visibility="{Binding Data.IsTeacher, Source={StaticResource VmProxy}, Converter={StaticResource BoolToVis}}">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <TextBlock Text="✕" FontSize="16" FontWeight="Bold"
                                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                                               Foreground="White"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>
    </Grid>
</UserControl>
